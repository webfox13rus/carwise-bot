import logging
from datetime import datetime
from aiogram import Bot, Router
from apscheduler.schedulers.asyncio import AsyncIOScheduler

from database import SessionLocal, User, Car
from config import config

router = Router()
logger = logging.getLogger(__name__)

# –°–ª–æ–≤–∞—Ä—å —Å —Å–µ–∑–æ–Ω–Ω—ã–º–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏: –º–µ—Å—è—Ü-–¥–µ–Ω—å -> —Ç–µ–∫—Å—Ç
SEASONAL_REMINDERS = {
    # –û—Å–µ–Ω—å
    (10, 1): "üçÇ *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–ü–æ—Ä–∞ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∑–∏–º–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ —à–∏–Ω (–ø–æ—Ä–∞ –º–µ–Ω—è—Ç—å –Ω–∞ –∑–∏–º–Ω–∏–µ)\n‚Ä¢ –£—Ä–æ–≤–µ–Ω—å –∞–Ω—Ç–∏—Ñ—Ä–∏–∑–∞\n‚Ä¢ –ó–∞—Ä—è–¥ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞\n‚Ä¢ –†–∞–±–æ—Ç—É –æ—Ç–æ–ø–∏—Ç–µ–ª—è",
    (10, 15): "‚ùÑÔ∏è *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–ï—Å–ª–∏ –µ—â—ë –Ω–µ —Å–º–µ–Ω–∏–ª–∏ —Ä–µ–∑–∏–Ω—É, —Å–∞–º–æ–µ –≤—Ä–µ–º—è! –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–∞ –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–µ.",
    
    # –í–µ—Å–Ω–∞
    (3, 15): "üå∏ *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–í–µ—Å–Ω–∞ –±–ª–∏–∑–∫–æ! –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∞–≤—Ç–æ:\n‚Ä¢ –°–º–µ–Ω–∏—Ç–µ —Ä–µ–∑–∏–Ω—É –Ω–∞ –ª–µ—Ç–Ω—é—é\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä\n‚Ä¢ –û—á–∏—Å—Ç–∏—Ç–µ —Ä–∞–¥–∏–∞—Ç–æ—Ä –æ—Ç –≥—Ä—è–∑–∏",
    (4, 1): "‚òÄÔ∏è *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–ü–æ—Ä–∞ –∑–∞–Ω—è—Ç—å—Å—è –∫—É–∑–æ–≤–æ–º –ø–æ—Å–ª–µ –∑–∏–º—ã: –º–æ–π–∫–∞, –ø–æ–ª–∏—Ä–æ–≤–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–æ—Å—Ç–µ–π.",
    
    # –õ–µ—Ç–æ
    (6, 1): "‚õ±Ô∏è *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–õ–µ—Ç–æ–º –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞:\n‚Ä¢ –î–∞–≤–ª–µ–Ω–∏–µ–º –≤ —à–∏–Ω–∞—Ö\n‚Ä¢ –£—Ä–æ–≤–Ω–µ–º –æ—Ö–ª–∞–∂–¥–∞—é—â–µ–π –∂–∏–¥–∫–æ—Å—Ç–∏\n‚Ä¢ –†–∞–±–æ—Ç–æ–π –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞",
    
    # –ó–∏–º–∞
    (12, 1): "‚õÑÔ∏è *–°–µ–∑–æ–Ω–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–ó–∏–º–∞ –Ω–∞ –ø–æ—Ä–æ–≥–µ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ó–∏–º–Ω—é—é —Ä–µ–∑–∏–Ω—É\n‚Ä¢ –ê–Ω—Ç–∏—Ñ—Ä–∏–∑\n‚Ä¢ –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä\n‚Ä¢ –ù–µ–∑–∞–º–µ—Ä–∑–∞–π–∫—É"
}

async def send_seasonal_reminders(bot: Bot):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ–∑–æ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –∞–≤—Ç–æ."""
    today = datetime.now().date()
    key = (today.month, today.day)
    
    if key not in SEASONAL_REMINDERS:
        logger.info(f"–ù–µ—Ç —Å–µ–∑–æ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ {today.strftime('%d.%m')}")
        return
    
    text = SEASONAL_REMINDERS[key]
    logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–µ–∑–æ–Ω–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ {today.strftime('%d.%m')}")
    
    with SessionLocal() as db:
        users = db.query(User).all()
        sent_count = 0
        for user in users:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤—Ç–æ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å —Ç–µ–º, —É –∫–æ–≥–æ –Ω–µ—Ç –º–∞—à–∏–Ω)
            cars = db.query(Car).filter(Car.user_id == user.id, Car.is_active == True).count()
            if cars == 0:
                continue
            try:
                await bot.send_message(user.telegram_id, text, parse_mode="Markdown")
                sent_count += 1
                logger.debug(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}: {e}")
        logger.info(f"–°–µ–∑–æ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")
